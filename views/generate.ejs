<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generate Ijazah</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 via-white to-white">
  <%- include('partials/navbar') %>
  <% const showResult = true; %>
  <div class="flex justify-center items-center min-h-[80vh] mt-20 mb-20">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-blue-100 p-10 transition duration-300">
      <h2 class="text-2xl font-bold mb-2 text-center text-blue-700">Generate Ijazah Digital</h2>
      <p class="text-center text-gray-500 mb-8">Isi data berikut untuk membuat ijazah digital dengan tanda tangan elektronik dan hash blockchain.</p>
      <form id="formIjazah" class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4">
        <!-- Informasi Mahasiswa -->
        <fieldset class="md:col-span-2 border border-blue-200 rounded-xl p-6">
          <legend class="text-blue-600 font-semibold px-2 text-lg">Informasi Mahasiswa</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mt-4">
            <div>
              <label class="block text-left font-medium text-gray-700">Nama Mahasiswa</label>
              <input name="student_name" class="w-full border p-2 rounded" placeholder="Nama Mahasiswa" required />

              <label class="block text-left font-medium text-gray-700 mt-4">NPM</label>
              <input name="npm" class="w-full border p-2 rounded" placeholder="NPM" required />

              <label class="block text-left font-medium text-gray-700 mt-4">Tempat Lahir</label>
              <input name="birth_place" class="w-full border p-2 rounded" placeholder="Tempat Lahir" required />

              <label class="block text-left font-medium text-gray-700 mt-4">Tanggal Lahir</label>
              <input name="birth_date" type="date" class="w-full border p-2 rounded" required />

              
            </div>

            <div>
              <label class="block text-left font-medium text-gray-700">IPK</label>
              <input name="ipk" class="w-full border p-2 rounded" placeholder="IPK" required />

              <label class="block text-left font-medium text-gray-700 mt-4">Program Studi</label>
              <input name="study" class="w-full border p-2 rounded" placeholder="Program Studi" required />

              <label class="block text-left font-medium text-gray-700 mt-4">Tanggal Lulus</label>
              <input name="ijazah_date" type="date" class="w-full border p-2 rounded" required />
              
            </div>
          </div>
        </fieldset>

        <!-- Informasi Rektor -->
        <fieldset class="md:col-span-2 border border-purple-200 rounded-xl p-6 mt-4">
          <legend class="text-purple-700 font-semibold px-2 text-lg">Informasi Rektor</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mt-4">
            <div>
              <label class="block text-left font-medium text-gray-700">Nama Rektor</label>
              <input name="rector_name" class="w-full border p-2 rounded" placeholder="Nama Rektor" required />
            </div>
            <div>
              <label class="block text-left font-medium text-gray-700">NIP</label>
              <input name="nip" class="w-full border p-2 rounded" placeholder="NIP" required />
            </div>
          </div>

          <!-- Tombol -->
          <div class="mt-6">
            <button id="generateButton" class="w-full bg-[#8e24aa] text-white py-2 rounded hover:bg-[#9c38b6] transition duration-200 transform active:scale-95 flex items-center justify-center gap-2">
              <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
              </svg>
              <span id="buttonText">Generate & Sign</span>
            </button>
          </div>
        </fieldset>
      </form>

      <div class="flex flex-col md:flex-row gap-4 mt-8 hidden" id="resultIjazah">
      <button type="button" onclick="document.getElementById('modalPreview').classList.remove('hidden');" class="w-full md:w-auto bg-[#b92b27] text-white px-4 py-2 rounded transition duration-150 active:scale-95">
        Preview Ijazah
      </button>
</div>

    </div>
  </div>
  <!-- Modal Preview Ijazah -->
  <div id="modalPreview" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50  hidden">
    <div class="bg-white rounded-xl shadow-xl p-8 max-w-5xl w-full relative overflow-auto modal-content">
    </div>
  </div>
  <%- include('partials/footer') %>

  <script>
    document.getElementById('formIjazah').addEventListener('submit', async function (e) {
      e.preventDefault(); // Mencegah reload halaman

      const formData = new FormData(this);
      const ijazahJson = JSON.stringify(Object.fromEntries(formData.entries()));

      const button = document.getElementById('generateButton');
      const spinner = document.getElementById('spinner');
      const buttonText = document.getElementById('buttonText');

      spinner.classList.remove('hidden');
      buttonText.textContent = 'Memproses...';
      button.disabled = true;

      try {
        const response = await fetch('/generate', {
          method: 'POST',
          body: ijazahJson,
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          alert('Terjadi kesalahan saat generate ijazah');
          return;
        }

        const result = await response.json();
        document.getElementById('resultIjazah').classList.remove('hidden');
        
        document.querySelector('#modalPreview .modal-content').innerHTML = `
          <button
            onclick="document.getElementById('modalPreview').classList.add('hidden')"
            class="absolute top-4 right-4 text-gray-500 hover:text-red-600 text-4xl leading-none p-2 rounded-full hover:bg-gray-100 transition"
            aria-label="Close modal"
          >
            &times;
          </button>
          <h3 class="text-xl font-bold mb-6 text-blue-700 text-center col-span-2">Preview Ijazah</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
              <div class="mb-2"><b>Hash Ijazah:</b> <span class="break-all">${result.hash}</span></div>
              <div class="mb-4"><b>Block:</b> <span class="break-all">${result.blockchain.block}</span></div>
              <div class="mb-4"><b>Transaction Hash:</b> <span class="break-all">${result.blockchain.tx_hash}</span></div>
              <div class="mb-4"><b>Etherscan URL:</b> <a href="${result.blockchain.etherscan_url}" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium hover:underline transition" target="_blank" rel="noopener noreferrer"><span class="break-all">${result.blockchain.etherscan_url}</span></a></div>
              <a href="${result.ijazah_path}" download class="bg-[#1565c0] text-white px-4 py-2 rounded transition duration-150 active:scale-95">
                Download PDF  
              </a>
            </div>
            <div class="flex items-center justify-center">
              <iframe src="${result.ijazah_path}" class="border w-full max-w-lg h-96"></iframe>
            </div>
          </div>
        `;
      } catch (error) {
        alert('Terjadi error saat menghubungi server.');
      } finally {
        // Sembunyikan loading
        spinner.classList.add('hidden');
        buttonText.textContent = 'Generate & Sign';
        button.disabled = false;
      }
    });
  </script>
</body>
</html>
